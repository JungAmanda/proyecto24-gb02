<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Usuario</title>
    <!-- Ruta del CSS -->
    <link rel="stylesheet" href="/static/perfil.css">
    <link rel="stylesheet" href="/static/header_footer.css">
</head>
<body>
    {% include "header.html" %}

    <!-- Contenido Principal -->
    <main>
        <!-- Sección del Perfil -->
        <section class="profile-card">
            <h2>Información Personal</h2>
            <form action="/usuarios/{{ user_id }}" id="profile-form">
                <label for="name">Nombre:</label>
                <input type="text" id="name" name="name" value="{{nombre}}" class="form-input" required>

                <br>
                <label for="name">Contraseña:</label>
                <input type="password" id="password" name="password" value="{{password}}" class="form-input" required>
                
                <br>
                <label for="email">Correo Electrónico:</label>
                <input type="email" id="email" name="email" value="{{email}}" class="form-input" readonly>
                
                <br>
                <label for="language">Idioma:</label>
                <select id="language" name="language" class="form-select">
                    <option value="es">Español</option>
                    <option value="en">Inglés</option>
                    <option value="fr">Francés</option>
                </select>

                <br>
                <button type="button" id="update-profile-btn" class="btn">Actualizar Perfil</button>
            </form>
        </section>

        <!-- Sección del Método de Pago -->
        <section class="payment-section profile-card">
            <h2>Método de Pago</h2>
            <form id="payment-form">
                <label for="payment-method">Método de Pago:</label>
                <select id="payment-method" name="payment-method" class="form-select">
                    <option value="credit_card">Tarjeta de Crédito</option>
                    <option value="paypal">PayPal</option>
                </select>

                <label for="payment-details">Detalles:</label>
                <input type="text" id="payment-details" name="payment-details" class="form-input">

                <button type="button" id="update-payment-btn" class="btn">Actualizar Método de Pago</button>
            </form>
        </section>

        <!-- Sección de Me Gusta -->
        <section class="likes-section">
            <h2>Contenido Marcado con "Me Gusta"</h2>
            <ul>
                {% for item in me_gusta %}
                    <li>
                        <a href="#" 
                           data-id-usuario="user_id" 
                           data-id-contenido="{{ item.id }}"
                           onclick="confirmarEliminar(this)">
                            {{ item.titulo }}
                            {{item.id}}
                        </a>
                    </li>
                {% endfor %}
            </ul>
            <script>
                async function confirmarEliminar(element) {
                    const idUsuario = element.getAttribute("data-id-usuario");
                    const idContenido = element.getAttribute("data-id-contenido");
            
                    // Mostrar un cuadro de diálogo de confirmación
                    const confirmar = confirm("¿Estás seguro de que deseas eliminar este contenido de tu lista de 'Me gusta'?");
            
                    if (confirmar) {
                        // Si el usuario confirma, realiza la petición al endpoint
                        const url = `/usuarios/${idUsuario}/me-gusta/${idContenido}`;
            
                        const response = await fetch(url, {
                            method: "DELETE",
                        });
            
                        if (response.ok) {
                            alert("Contenido eliminado de la lista de Me gusta");
                            // Elimina visualmente el elemento de la lista
                            element.parentNode.remove();
                        } else {
                            const data = await response.json();
                            alert(data.detail || "Error al eliminar el contenido");
                        }
                    }
                }
            </script>            
        </section>
    </main>
    
    {% include "footer.html" %}
    
    <script>
        const userId = "{{user_id}}"
        // Cargar datos del usuario
        fetch(`/usuarios/${userId}`)
            .then(response => response.json())
            .then(user => {
                document.getElementById("nombre").value = user.nombre;
                document.getElementById("email").value = user.email;
                document.getElementById("idioma").value = user.idioma || "es";
            })
            .catch(error => console.error("Error al cargar el perfil:", error));

        // Cargar contenidos marcados como "me gusta"
        fetch(`/usuarios/{userId}/me-gusta/{idContenido}`)
            .then(response => response.json())
            .then(data => {
                const likesList = document.getElementById("likes-list");
                data.forEach(content => {
                    const listItem = document.createElement("li");
                    listItem.textContent = `${content.nombre} - ${content.tipo}`;
                    likesList.appendChild(listItem);
                });
            })
            .catch(error => console.error("Error al cargar los contenidos:", error));

        // Actualizar perfil
        document.getElementById("update-profile-btn").addEventListener("click", () => {
            const updatedData = {
                nombre: document.getElementById("nombre").value,
                idioma: document.getElementById("idioma").value
            };

            fetch(`/usuarios/${userId}/perfil`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updatedData)
            })
                .then(response => response.json())
                .then(result => alert(result.message))
                .catch(error => console.error("Error al actualizar perfil:", error));
        });

        // Actualizar método de pago
        document.getElementById("update-payment-btn").addEventListener("click", () => {
            const paymentData = {
                tipo: document.getElementById("payment-method").value,
                numeroTarjeta: document.getElementById("payment-details").value,
            };

            fetch(`/usuarios/${userId}/metodos-pago`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(paymentData)
            })
                .then(response => response.json())
                .then(result => alert("Método de pago actualizado correctamente"))
                .catch(error => console.error("Error al actualizar el método de pago:", error));
        });
    </script>
</body>
</html>
